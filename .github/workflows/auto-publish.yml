name: Build

on: push

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    # Setup the docs
    - name: Setup
      run: |
        pwd
        cd hyperbook
        npx hyperbook setup
        if test ! -d .hyperbook; then echo "No output!"; exit 1; fi
      
    - name: Generate
      if: github.ref == 'refs/heads/main'
      run: |
        pwd
        message="$(git log --format='Deploy %h %<|(50,trunc)%f' -1)"

        echo "== getting live branch..."
        git clone https://github.com/software-challenge/docs --branch live --single-branch .hyperbook/out
        npx hyperbook build

        echo "== creating commit..."
        cd .hyperbook/out
        git config user.email "info@software-challenge.de"
        git config user.name "GitHub Publish Action"
        git add --all
        git commit -m "$message"

    # Push the generated docs to the live branch
    - name: Deploy
      if: github.ref == 'refs/heads/main'
      run: |
        pwd
        git push https://socha-bot:${{ secrets.ACCESS_TOKEN }}@github.com/software-challenge/docs

    - name: Cleanup
      run: |
        pwd
        echo "== cleaning up"
        cd ../..
        rm -rf ./.hyperbook
